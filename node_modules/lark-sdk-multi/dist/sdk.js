var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { SDK_API_URL, SDK_URL } from './config/constants';
import axios from 'axios';
class LoanEligibilitySDK {
    constructor(config) {
        this.eventHandlers = new Map();
        this.iframeUrl = '';
        this.childWindow = null;
        this.apiKey = '';
        this.apiSecret = '';
        this.sessionToken = '';
        this.popupWindow = null;
        this.containerId = 'larkfinserv-sdk-container';
        this.config = config;
        // this.iframeUrl = this.generateIframeUrl();
        // this.validateConfig();
        this.generateSessionToken();
        this.setupMessageListener();
        this.setupSessionClearingListener();
    }
    initialize(config) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            // console.log("ğŸš€ Frontend SDK: initialize method called with config:", config);
            try {
                // Merge incoming config with existing config
                this.config = Object.assign(Object.assign({}, this.config), config);
                // console.log("ğŸ” Frontend SDK: Merged config:", this.config);
                // Validate required configuration
                if (!this.config.apiKey || !this.config.apiSecret) {
                    throw new Error('Missing required configuration: apiKey and apiSecret are required');
                }
                let endpoint = `${SDK_API_URL}/loan-sdk/init`;
                if (this.config.phoneNumber) {
                    endpoint = `${endpoint}?phone=${this.config.phoneNumber}&isVerified=${true}`;
                }
                // Make API request
                // console.log("ğŸ” Frontend SDK: Making init API call to:", endpoint);
                // console.log("ğŸ” Frontend SDK: Headers:", {
                //   'X-SDK-Key': this.config.apiKey,
                //   'X-SDK-Secret': this.config.apiSecret,
                //   'Content-Type': 'application/json',
                //   'ngrok-skip-browser-warning': true,
                // });
                // console.log("ğŸ” Frontend SDK: Config before API call:", {
                //   apiKey: this.config.apiKey,
                //   apiSecret: this.config.apiSecret,
                //   phoneNumber: this.config.phoneNumber,
                //   partnerId: this.config.partnerId
                // });
                // console.log("ğŸš€ Frontend SDK: Making API request now...");
                const response = yield axios.get(endpoint, {
                    headers: {
                        'X-SDK-Key': this.config.apiKey,
                        'X-SDK-Secret': this.config.apiSecret,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': true,
                    },
                    timeout: 10000, // 10 seconds timeout
                });
                // console.log("âœ… Frontend SDK: API request completed successfully");
                // console.log("âœ… Frontend SDK: Init API response:", response.data);
                // console.log("ğŸ” Frontend SDK: API response user object:", response.data.user);
                // console.log("ğŸ” Frontend SDK: API response user.id:", response.data.user?.id);
                // Validate response structure
                if (!response.data || !response.data.sessionId || !response.data.themeConfig) {
                    throw new Error('Invalid response structure from initialization API');
                }
                // Map user.id to userId explicitly
                const userId = ((_a = response.data.user) === null || _a === void 0 ? void 0 : _a.id) || response.data.userId || this.config.userId;
                // console.log("ğŸ” Frontend SDK: Mapping user.id to userId:", {
                //   "response.data.user?.id": response.data.user?.id,
                //   "response.data.userId": response.data.userId,
                //   "this.config.userId": this.config.userId,
                //   "final userId": userId
                // });
                // Validate that we have a valid userId
                if (!userId || userId.trim() === '') {
                    // console.warn("âš ï¸ Frontend SDK: No valid userId found in API response, this may cause issues");
                    // console.warn("âš ï¸ Frontend SDK: API response user object:", response.data.user);
                    // console.warn("âš ï¸ Frontend SDK: Full API response:", response.data);
                }
                else {
                    // console.log("âœ… Frontend SDK: Successfully mapped user.id to userId:", userId);
                }
                // Update configuration
                this.config = Object.assign(Object.assign({}, this.config), { theme: response.data.themeConfig, sessionId: response.data.sessionId, partnerName: response.data.partnerName, partnerId: response.data.partnerId, userId: userId, currentJourneyStep: response.data.currentJourneyStep, stepProgressSummary: response.data.stepProgressSummary, hasActiveLoan: response.data.hasActiveLoan, loanDetails: response.data.loanDetails, requiresEmailVerification: response.data.requiresEmailVerification });
                // console.log("ğŸ” Frontend SDK: Updated config after init API:", {
                //   sessionId: this.config.sessionId,
                //   userId: this.config.userId,
                //   partnerId: this.config.partnerId,
                //   consentData: this.config.consentData
                // });
                // Store config in sessionStorage for SDK access
                const sessionConfig = {
                    apiKey: this.config.apiKey,
                    apiSecret: this.config.apiSecret,
                    sessionId: this.config.sessionId,
                    partnerId: this.config.partnerId,
                    partnerName: this.config.partnerName,
                    userId: this.config.userId,
                };
                sessionStorage.setItem('lark_appConfig', JSON.stringify(sessionConfig));
                // console.log("ğŸ’¾ Frontend SDK: Stored config in sessionStorage:", sessionConfig);
                // // Submit consents immediately after init API response if consentData is provided
                // console.log("ğŸ” Frontend SDK: Checking consentData:", this.config.consentData);
                // console.log("ğŸ” Frontend SDK: consentData exists:", !!this.config.consentData);
                // console.log("ğŸ” Frontend SDK: userId exists:", !!this.config.userId);
                // console.log("ğŸ” Frontend SDK: sessionId exists:", !!this.config.sessionId);
                // console.log("ğŸ” Frontend SDK: currentJourneyStep:", this.config.currentJourneyStep);
                // console.log("ğŸ” Frontend SDK: stepProgressSummary:", this.config.stepProgressSummary);
                // console.log("ğŸ” Frontend SDK: Full config:", this.config);
                if (this.config.consentData && this.config.userId) {
                    // console.log("ğŸš€ Frontend SDK: Submitting consents immediately after init API response");
                    // console.log("ğŸ” Frontend SDK: About to call submitConsentData()");
                    try {
                        yield this.submitConsentData();
                        console.log('âœ… Frontend SDK: Consent submission completed successfully');
                    }
                    catch (error) {
                        console.error('âŒ Frontend SDK: Error during consent submission:', error);
                    }
                }
                else {
                    // console.log("âš ï¸ Frontend SDK: Missing required data for consent submission:");
                    // console.log("  - consentData:", !!this.config.consentData);
                    // console.log("  - userId:", !!this.config.userId);
                    // console.log("  - sessionId:", !!this.config.sessionId);
                }
                // Store step progress information for redirection
                if (this.config.stepProgressSummary) {
                    // console.log("ğŸ“Š Frontend SDK: Step progress summary received:", this.config.stepProgressSummary);
                    sessionStorage.setItem('lark_stepProgress', JSON.stringify(this.config.stepProgressSummary));
                }
                // console.log("ğŸ”— Frontend SDK: About to generate iframe URL with userId:", this.config.userId);
                this.iframeUrl = this.generateIframeUrl();
                // console.log("ğŸ”— Frontend SDK: Generated iframe URL:", this.iframeUrl);
                // console.log("âœ… Frontend SDK: Initialize method completed successfully");
            }
            catch (error) {
                console.log('error', error);
                let errorMessage = 'Failed to initialize SDK';
                if (axios.isAxiosError(error)) {
                    // Handle Axios-specific errors
                    if (error.response) {
                        // Server responded with a status code outside 2xx
                        errorMessage += `: ${error.response.status} - ${((_b = error.response.data) === null || _b === void 0 ? void 0 : _b.message) || 'No error message'}`;
                    }
                    else if (error.request) {
                        // Request was made but no response received
                        errorMessage += ': No response received from server';
                    }
                    else {
                        // Something happened in setting up the request
                        errorMessage += `: ${error.message}`;
                    }
                }
                else if (error instanceof Error) {
                    // Handle other Error types
                    errorMessage += `: ${error.message}`;
                }
                console.error(errorMessage, error);
                throw new Error(errorMessage);
            }
        });
    }
    validateConfig() {
        if (!this.config.partnerId) {
            throw new Error('Missing required configuration: partnerId, partnerName, and authToken are required');
        }
    }
    setupMessageListener() {
        window.addEventListener('message', (event) => {
            // In production, check origin
            // if (event.origin !== LARKFINSERV_ORIGIN_URL) return; // add check for the larkfinserv-sdk hosted url
            // console.log(event.origin, event.data, 'origin');
            const { data } = event;
            if (!(data === null || data === void 0 ? void 0 : data.type))
                return;
            switch (data.type) {
                case 'READY':
                    this.emitEvent('READY');
                    break;
                case 'ELIGIBILITY_RESULT':
                    console.log('ELIGIBILITY_RESULT', data);
                    this.emitEvent('ELIGIBILITY_RESULT', data.data);
                    // if not popup then close the frame
                    this.closeFrame();
                    break;
                case 'ERROR':
                    this.closeFrame();
                    this.emitEvent('ERROR', { error: data.data.error });
                    break;
                case 'CLOSE':
                    this.closeFrame();
                    this.emitEvent('CLOSE');
                    break;
                case 'CLOSE_FRAME':
                    this.emitEvent('CLOSE_FRAME', data.data);
                    this.closeFrame();
                    break;
            }
        });
    }
    setupSessionClearingListener() {
        window.addEventListener('lark-session-cleared', (event) => {
            const customEvent = event;
            // console.log('ğŸš¨ Frontend SDK: Session cleared event received:', customEvent.detail);
            const { reason, mobileNumber } = customEvent.detail;
            // Send logout message to larkfinserv-sdk iframe if it exists
            console.log('ğŸ“¤ Frontend SDK: Attempting to send logout message to SDK...');
            this.sendLogoutMessageToSDK();
            // Also try to clear localStorage directly as a fallback
            this.clearSDKDataDirectly();
            // Close any open frames/windows
            this.closeFrame();
            // Emit session cleared event to listeners
            this.emitEvent('SESSION_CLEARED', {
                reason,
                mobileNumber,
                timestamp: new Date().toISOString(),
            });
            // If we have a mobile number and the reason is API error, reinitialize
            if (mobileNumber && reason === 'api_error') {
                // console.log('ğŸ”„ Frontend SDK: Reinitializing SDK with mobile number:', mobileNumber);
                this.handleSessionReinitialization(mobileNumber);
            }
        });
    }
    handleSessionReinitialization(mobileNumber) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                // Reinitialize with the preserved mobile number
                const reinitConfig = Object.assign(Object.assign({}, this.config), { phoneNumber: mobileNumber, isVerified: true });
                // console.log('ğŸ”„ Frontend SDK: Reinitializing with config:', reinitConfig);
                yield this.initialize(reinitConfig);
                // Emit reinitialization success event
                this.emitEvent('SDK_REINITIALIZED', {
                    mobileNumber,
                    timestamp: new Date().toISOString(),
                });
            }
            catch (error) {
                console.error('âŒ Frontend SDK: Failed to reinitialize after session clearing:', error);
                this.emitEvent('REINITIALIZATION_FAILED', {
                    error: {
                        code: 'REINITIALIZATION_FAILED',
                        message: error instanceof Error ? error.message : 'Unknown error',
                    },
                    mobileNumber,
                    timestamp: new Date().toISOString(),
                });
            }
        });
    }
    /**
     * Send logout message to larkfinserv-sdk iframe
     */
    sendLogoutMessageToSDK() {
        try {
            // Find the larkfinserv-sdk iframe
            const iframe = document.getElementById('larkfinserv-sdk-container');
            console.log('ğŸ” Frontend SDK: Looking for iframe with ID larkfinserv-sdk-container');
            // console.log('ğŸ” Frontend SDK: Found iframe:', iframe);
            if (iframe && iframe.contentWindow) {
                console.log('ğŸ“¤ Frontend SDK: Sending logout message to larkfinserv-sdk iframe');
                // console.log('ğŸ“¤ Frontend SDK: Iframe origin:', iframe.src);
                const logoutMessage = {
                    type: 'LOGOUT_REQUEST',
                    data: {
                        reason: 'user_logout',
                        timestamp: new Date().toISOString(),
                    },
                };
                // console.log('ğŸ“¤ Frontend SDK: Logout message payload:', logoutMessage);
                // Send logout message to the iframe
                iframe.contentWindow.postMessage(logoutMessage, '*');
                console.log('âœ… Frontend SDK: Logout message sent to larkfinserv-sdk');
            }
            else {
                console.warn('âš ï¸ Frontend SDK: larkfinserv-sdk iframe not found or not accessible');
                console.warn('âš ï¸ Frontend SDK: Available elements with larkfinserv in ID:', Array.from(document.querySelectorAll('[id*="larkfinserv"]')).map((el) => el.id));
            }
        }
        catch (error) {
            console.error('âŒ Frontend SDK: Error sending logout message to SDK:', error);
        }
    }
    generateSessionToken() {
        // In a real implementation, this would be a proper JWT or server-generated token
        this.sessionToken = btoa(JSON.stringify({
            partnerId: this.config.partnerId,
            timestamp: Date.now(),
            ttl: 3600, // 1 hour
        }));
    }
    generateIframeUrl() {
        const baseUrl = this.config.environment === 'sandbox' ? SDK_URL : SDK_URL;
        const params = new URLSearchParams();
        params.append('authKey', this.config.apiKey);
        if (this.config.apiSecret) {
            params.append('authSecret', this.config.apiSecret);
        }
        if (this.config.sessionId) {
            params.append('sessionId', this.config.sessionId);
        }
        if (this.config.partnerId) {
            params.append('partnerId', this.config.partnerId);
        }
        if (this.config.userId) {
            params.append('userId', this.config.userId);
        }
        if (this.config.theme) {
            params.append('theme', JSON.stringify(this.config.theme));
        }
        if (this.config.phoneNumber) {
            params.append('phoneNumber', this.config.phoneNumber);
        }
        const finalUrl = `${baseUrl}?${params.toString()}`;
        // console.log('ğŸ”— Frontend SDK: Generated iframe URL with userId:', this.config.userId);
        // console.log('ğŸ”— Frontend SDK: Final iframe URL:', finalUrl);
        // console.log('ğŸ”— Frontend SDK: URL parameters:', params.toString());
        return finalUrl;
    }
    openEligibilityCheck(mode) {
        return __awaiter(this, void 0, void 0, function* () {
            // Ensure consent submission happens before opening any mode
            // console.log("ğŸš€ Frontend SDK: openEligibilityCheck called with mode:", mode);
            // console.log("ğŸ” Frontend SDK: Current config userId:", this.config.userId);
            // console.log("ğŸ” Frontend SDK: Current iframeUrl:", this.iframeUrl);
            // console.log("ğŸ” Frontend SDK: Checking if consent submission is needed");
            // Regenerate iframe URL if userId is available but not in URL
            if (this.config.userId && !this.iframeUrl.includes('userId=')) {
                // console.log("ğŸ”§ Frontend SDK: Regenerating iframe URL with userId:", this.config.userId);
                this.iframeUrl = this.generateIframeUrl();
                // console.log('ğŸ”§ Frontend SDK: New iframeUrl:', this.iframeUrl);
            }
            if (this.config.consentData && this.config.userId) {
                // console.log('ğŸš€ Frontend SDK: Submitting consents before opening', mode, 'mode');
                try {
                    yield this.submitConsentData();
                    console.log('âœ… Frontend SDK: Consent submission completed before opening', mode, 'mode');
                }
                catch (error) {
                    console.error('âŒ Frontend SDK: Error during consent submission before opening', mode, 'mode:', error);
                }
            }
            else {
                console.log('âš ï¸ Frontend SDK: No consent data or userId, skipping consent submission for', mode, 'mode');
            }
            if (mode === 'popup') {
                const width = 500;
                const height = 700;
                const left = (window.screen.width - width) / 2;
                const top = (window.screen.height - height) / 2;
                this.childWindow = window.open(this.iframeUrl, '_blank', `width=${width},height=${height},scrollbars=yes,left=${left},top=${top}`);
                this.onClosePopupListener();
                this.emitEvent('INITIATED');
                return;
            }
            if (mode === 'inline') {
                // Create backdrop overlay if it doesn't exist
                let backdrop = document.getElementById(this.containerId + '-backdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = this.containerId + '-backdrop';
                    backdrop.style.position = 'fixed';
                    backdrop.style.top = '0';
                    backdrop.style.left = '0';
                    backdrop.style.width = '100vw';
                    backdrop.style.height = '100vh';
                    backdrop.style.background = 'rgba(0,0,0,0.4)';
                    backdrop.style.zIndex = '999';
                    backdrop.style.opacity = '0';
                    backdrop.style.transition = 'opacity 0.3s';
                    document.body.appendChild(backdrop);
                    setTimeout(() => {
                        backdrop.style.opacity = '1';
                    }, 10);
                    // backdrop.onclick = () => {
                    //   this.closeFrame();
                    //   this.emitEvent('CLOSE_FRAME');
                    // };
                }
                // Create container if it doesn't exist
                let container = document.getElementById(this.containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = this.containerId;
                    container.setAttribute('role', 'dialog');
                    container.setAttribute('aria-modal', 'true');
                    container.setAttribute('tabindex', '-1');
                    container.style.position = 'fixed';
                    container.style.top = '50%';
                    container.style.left = '50%';
                    container.style.transform = 'translate(-50%, -50%)';
                    container.style.width = '500px';
                    container.style.maxWidth = '95vw';
                    container.style.height = '700px';
                    container.style.maxHeight = '95vh';
                    container.style.backgroundColor = 'white';
                    container.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
                    container.style.zIndex = '1000';
                    container.style.borderRadius = '12px';
                    container.style.display = 'flex';
                    container.style.flexDirection = 'column';
                    container.style.opacity = '0';
                    container.style.transition = 'opacity 0.3s';
                    document.body.appendChild(container);
                    setTimeout(() => {
                        container.style.opacity = '1';
                    }, 10);
                }
                container.innerHTML = '';
                // Create header with close button
                const header = document.createElement('div');
                header.style.padding = '10px 15px';
                header.style.display = 'flex';
                header.style.justifyContent = 'flex-end';
                header.style.alignItems = 'center';
                header.style.borderBottom = '1px solid #eee';
                const closeButton = document.createElement('button');
                closeButton.innerHTML = '&times;'; // Using Ã— symbol
                closeButton.style.background = 'none';
                closeButton.style.border = 'none';
                closeButton.style.fontSize = '24px';
                closeButton.style.cursor = 'pointer';
                closeButton.style.padding = '0 10px';
                closeButton.style.color = '#666';
                closeButton.addEventListener('click', () => {
                    this.closeFrame();
                    this.emitEvent('CLOSE_FRAME');
                });
                header.appendChild(closeButton);
                container.appendChild(header);
                // Create iframe container
                const iframeContainer = document.createElement('div');
                iframeContainer.style.flex = '1';
                iframeContainer.style.overflow = 'hidden';
                iframeContainer.style.borderRadius = '0 0 12px 12px';
                // Create and append iframe
                this.iframe = document.createElement('iframe');
                // console.log('ğŸ”— Frontend SDK: Setting iframe src to (inline mode):', this.iframeUrl);
                this.iframe.src = this.iframeUrl;
                this.iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-popups allow-forms');
                this.iframe.setAttribute('allow', 'camera; microphone');
                this.iframe.style.width = '100%';
                this.iframe.style.height = '100%';
                this.iframe.style.border = 'none';
                iframeContainer.appendChild(this.iframe);
                container.appendChild(iframeContainer);
                this.emitEvent('INITIATED');
            }
            if (mode === 'embedded') {
                // Always target your React container div
                const containerId = this.containerId;
                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    container.style.width = '100%';
                    container.style.minHeight = '400px';
                    container.style.display = 'flex';
                    container.style.justifyContent = 'center'; // center iframe
                    document.body.appendChild(container);
                }
                container.innerHTML = '';
                this.iframe = document.createElement('iframe');
                // console.log('ğŸ”— Frontend SDK: Setting iframe src to (embedded mode):', this.iframeUrl);
                this.iframe.src = this.iframeUrl;
                this.iframe.setAttribute('sandbox', 'allow-scripts allow-popups allow-forms allow-same-origin');
                this.iframe.setAttribute('allow', 'camera; microphone');
                // âœ… Responsive + Border styles
                this.iframe.style.width = '100%';
                this.iframe.style.maxWidth = '500px';
                this.iframe.style.height = '700px';
                this.iframe.style.border = 'none';
                // this.iframe.style.borderRadius = '8px';
                this.iframe.style.backgroundColor = '#fff';
                container.appendChild(this.iframe);
                this.emitEvent('INITIATED');
                return;
            }
        });
    }
    onClosePopupListener() {
        // Check periodically if the popup is closed
        console.log('onClosePopupListener');
        const interval = setInterval(() => {
            var _a;
            console.log(this.childWindow, (_a = this.childWindow) === null || _a === void 0 ? void 0 : _a.closed, 'closing status');
            if (this.childWindow && this.childWindow.closed) {
                clearInterval(interval); // Stop checking once closed
                this.childWindow = null;
                this.emitEvent('CLOSE_FRAME');
            }
        }, 500); // Check every 500ms
    }
    closeFrame() {
        if (this.childWindow) {
            this.childWindow.close();
            this.childWindow = null;
        }
        // Remove inline modal and backdrop
        const container = document.getElementById(this.containerId);
        if (container) {
            // Fade out before removing
            container.style.opacity = '0';
            setTimeout(() => {
                container.remove();
            }, 300);
        }
        const backdrop = document.getElementById(this.containerId + '-backdrop');
        if (backdrop) {
            backdrop.style.opacity = '0';
            setTimeout(() => {
                backdrop.remove();
            }, 300);
        }
    }
    on(event, handler) {
        if (!this.eventHandlers.has(event)) {
            this.eventHandlers.set(event, handler);
        }
    }
    off(event, _handler) {
        this.eventHandlers.delete(event);
    }
    sendData(data) {
        if (!this.iframe || !this.iframe.contentWindow) {
            throw new Error('Eligibility check iframe not open');
        }
        this.iframe.contentWindow.postMessage({
            type: 'USER_DATA_UPDATE',
            data,
            metadata: {
                partnerId: this.config.partnerId,
                // sessionToken: this.sessionToken,
            },
        }, '*'); // In production, specify exact origin
    }
    emitEvent(eventType, data) {
        const handler = this.eventHandlers.get(eventType);
        if (handler) {
            handler({ type: eventType, data: data || {} });
        }
    }
    handleError(error) {
        if (error instanceof Error) {
            return {
                success: false,
                error: {
                    code: 'SDK_ERROR',
                    message: error.message,
                },
            };
        }
        return {
            success: false,
            error: {
                code: 'SDK_ERROR',
                message: 'An unknown error occurred',
            },
        };
    }
    handleCloseMessage(_event) {
        if (this.popupWindow) {
            this.popupWindow.close();
            this.emitEvent('CLOSE');
        }
    }
    // Helper functions for consent submission
    getClientIP() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const response = yield axios.get('https://api.ipify.org?format=json', { timeout: 5000 });
                return response.data.ip;
            }
            catch (_a) {
                return 'unknown';
            }
        });
    }
    getDeviceFingerprint() {
        return __awaiter(this, void 0, void 0, function* () {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (ctx) {
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
            }
            const fingerprint = canvas.toDataURL();
            return btoa(fingerprint).substring(0, 50);
        });
    }
    // Public method to test consent submission for different modes
    testConsentSubmission() {
        return __awaiter(this, void 0, void 0, function* () {
            // console.log("ğŸ§ª Frontend SDK: Testing consent submission for all modes");
            // console.log("ğŸ” Frontend SDK: Current config:", this.config);
            if (this.config.consentData && this.config.userId) {
                console.log('ğŸš€ Frontend SDK: Testing consent submission');
                try {
                    yield this.submitConsentData();
                    console.log('âœ… Frontend SDK: Test consent submission completed successfully');
                }
                catch (error) {
                    console.error('âŒ Frontend SDK: Test consent submission failed:', error);
                }
            }
            else {
                console.log('âš ï¸ Frontend SDK: Cannot test consent submission - missing consentData or userId');
            }
        });
    }
    /**
     * Check for existing journey for a phone number
     */
    /**
     * Complete a journey step
     */
    completeJourneyStep(journeyStep, stepData) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.config.sessionId || !this.config.apiKey || !this.config.apiSecret) {
                console.error('âŒ SDK not initialized or missing credentials');
                return;
            }
            try {
                console.log(`âœ… Completing journey step: ${journeyStep}`);
                const response = yield axios.post(`${import.meta.env.VITE_API_URL}/loan-sdk/complete-journey-step`, {
                    sessionId: this.config.sessionId,
                    journeyStep,
                    stepData,
                }, {
                    headers: {
                        'X-SDK-Key': this.config.apiKey,
                        'X-SDK-Secret': this.config.apiSecret,
                        'Content-Type': 'application/json',
                    },
                });
                // console.log("âœ… Journey step completed successfully:", response.data);
                // Update step progress summary
                if (response.data.stepSummary) {
                    this.config.stepProgressSummary = response.data.stepSummary;
                }
                // Emit event
                this.eventHandlers.forEach((handler) => {
                    handler({
                        type: 'JOURNEY_STEP_COMPLETED',
                        data: {
                            completedStep: journeyStep,
                            nextStep: response.data.nextStep,
                            stepSummary: response.data.stepSummary,
                        },
                    });
                });
            }
            catch (error) {
                console.error('âŒ Error completing journey step:', error);
                this.eventHandlers.forEach((handler) => {
                    handler({
                        type: 'ERROR',
                        data: {
                            error: {
                                code: 'JOURNEY_STEP_ERROR',
                                message: 'Failed to complete journey step',
                            },
                        },
                    });
                });
            }
        });
    }
    // Method to submit consents after init API response
    submitConsentData() {
        return __awaiter(this, void 0, void 0, function* () {
            // console.log("ğŸš€ Frontend SDK: submitConsentData called - START");
            // console.log("ğŸ” Frontend SDK: consentData:", this.config.consentData);
            // console.log("ğŸ” Frontend SDK: userId:", this.config.userId);
            // console.log("ğŸ” Frontend SDK: sessionId:", this.config.sessionId);
            // console.log("ğŸ” Frontend SDK: partnerId:", this.config.partnerId);
            // console.log("ğŸ” Frontend SDK: apiKey:", this.config.apiKey);
            // console.log("ğŸ” Frontend SDK: apiSecret:", this.config.apiSecret);
            if (!this.config.consentData) {
                console.log('âš ï¸ Frontend SDK: No consent data provided, skipping consent submission');
                return;
            }
            if (!this.config.userId) {
                console.log('âš ï¸ Frontend SDK: No userId found, skipping consent submission');
                return;
            }
            if (!this.config.sessionId) {
                console.log('âš ï¸ Frontend SDK: No sessionId found, skipping consent submission');
                return;
            }
            console.log('âœ… Frontend SDK: All required data present, proceeding with consent submission');
            try {
                const consentPayload = {
                    userId: this.config.userId,
                    sessionId: this.config.sessionId,
                    provider: this.config.partnerId || 'UNKNOWN',
                    privacyConsent: this.config.consentData.privacyConsent,
                    promotionalConsent: this.config.consentData.promotionalConsent,
                    ipAddress: yield this.getClientIP(),
                    userAgent: navigator.userAgent,
                    deviceFingerprint: yield this.getDeviceFingerprint(),
                };
                // console.log("ğŸ“ Frontend SDK: Submitting consents:", consentPayload);
                // console.log("ğŸ” Frontend SDK: API URL:", `${SDK_API_URL}/loan-sdk/consents/submit`);
                // console.log("ğŸ” Frontend SDK: Headers:", {
                //   'X-SDK-Key': this.config.apiKey,
                //   'X-SDK-Secret': this.config.apiSecret,
                //   'Content-Type': 'application/json',
                //   'ngrok-skip-browser-warning': true,
                // });
                // console.log("ğŸš€ Frontend SDK: Making POST request to consent API...");
                const response = yield axios.post(`${SDK_API_URL}/loan-sdk/consents/submit`, consentPayload, {
                    headers: {
                        'X-SDK-Key': this.config.apiKey,
                        'X-SDK-Secret': this.config.apiSecret,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': true,
                    },
                    timeout: 10000,
                });
                // console.log("âœ… Frontend SDK: Consent API response received:", response.data);
                if (response.data.success) {
                    // console.log("âœ… Frontend SDK: Consents submitted successfully:", response.data);
                }
                else {
                    console.warn('âš ï¸ Frontend SDK: Consent submission returned non-success:', response.data);
                }
            }
            catch (error) {
                console.error('âŒ Frontend SDK: Failed to submit consents:', error);
            }
        });
    }
    // Session Management Methods
    /**
     * Manually trigger session clearing
     */
    clearSession() {
        console.log('ğŸ§¹ Frontend SDK: Manually clearing session');
        // Clear localStorage and sessionStorage
        localStorage.clear();
        sessionStorage.clear();
        // Clear browser caches
        if ('caches' in window) {
            caches.keys().then((names) => {
                names.forEach((name) => caches.delete(name));
            });
        }
        // Close any open frames
        this.closeFrame();
        // Emit session cleared event
        this.emitEvent('SESSION_CLEARED', {
            reason: 'manual',
            timestamp: new Date().toISOString(),
        });
    }
    /**
     * Get current session information
     */
    getSessionInfo() {
        return {
            hasMobileNumber: !!localStorage.getItem('phoneNumber'),
            hasAuthToken: !!localStorage.getItem('authToken'),
            hasSessionId: !!sessionStorage.getItem('lark_sessionId'),
            hasAppConfig: !!sessionStorage.getItem('lark_appConfig'),
            mobileNumber: localStorage.getItem('phoneNumber'),
        };
    }
    /**
     * Reinitialize SDK with mobile number from localStorage
     */
    reinitializeWithMobileNumber() {
        return __awaiter(this, void 0, void 0, function* () {
            const mobileNumber = localStorage.getItem('phoneNumber');
            if (!mobileNumber) {
                throw new Error('No mobile number found in localStorage');
            }
            console.log('ğŸ”„ Frontend SDK: Reinitializing with mobile number:', mobileNumber);
            const reinitConfig = Object.assign(Object.assign({}, this.config), { phoneNumber: mobileNumber, isVerified: true });
            yield this.initialize(reinitConfig);
        });
    }
    /**
     * Test function to manually trigger logout message (for testing)
     */
    testLogoutMessage() {
        console.log('ğŸ§ª Frontend SDK: Testing logout message sending');
        this.sendLogoutMessageToSDK();
    }
    /**
     * Test function to check userId mapping (for testing)
     */
    testUserIdMapping() {
        // console.log('ğŸ§ª Frontend SDK: Testing userId mapping');
        // console.log('Current config userId:', this.config.userId);
        // console.log('SessionStorage userId:', JSON.parse(sessionStorage.getItem('lark_appConfig') || '{}').userId);
    }
    /**
     * Clear SDK data directly as a fallback when iframe communication fails
     */
    clearSDKDataDirectly() {
        try {
            console.log('ğŸ§¹ Frontend SDK: Clearing SDK data directly as fallback');
            // Clear all larkfinserv-sdk related localStorage items
            const keysToRemove = [
                'lark_flowState',
                'lark_appConfig',
                'lark_userData',
                'lark_opportunityStatus',
                'lark_opportunityStatusTimestamp',
                'lark_hasActiveLoan',
                'lark_loanDetails',
                'selectedOffer',
                'panNumber',
                'phoneNumber',
                'authToken',
                'eligibility_session_id',
                'opportunityId',
            ];
            keysToRemove.forEach((key) => {
                localStorage.removeItem(key);
                console.log('ğŸ—‘ï¸ Frontend SDK: Removed localStorage key:', key);
            });
            // Clear sessionStorage
            sessionStorage.clear();
            console.log('ğŸ—‘ï¸ Frontend SDK: Cleared sessionStorage');
            // Dispatch a custom event to trigger Redux state clearing
            const clearEvent = new CustomEvent('lark-clear-redux-state', {
                detail: {
                    reason: 'frontend_sdk_fallback',
                    timestamp: new Date().toISOString(),
                },
            });
            window.dispatchEvent(clearEvent);
            console.log('ğŸ“¢ Frontend SDK: Dispatched Redux clear event');
        }
        catch (error) {
            console.error('âŒ Frontend SDK: Error clearing SDK data directly:', error);
        }
    }
}
export default LoanEligibilitySDK;
